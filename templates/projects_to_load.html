{% extends base_template %} {% block head_css %} {{ super() }}
<link
  rel="stylesheet"
  type="text/css"
  href="https://unpkg.com/ag-grid-community/styles/ag-grid.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css"
/>

<!-- Include AG-Grid JS -->
<script
  type="text/javascript"
  src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"
></script>

<!-- <link rel="stylesheet" type="text/css" href="{{ url_for_asset('ag-theme-alpine.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for_asset('ag-grid.css') }}">
<script src="{{ url_for_asset('ag-grid-community.min.noStyle.js') }}"></script> -->

<!-- <script src="../static/js/ag-grid-community.min.noStyle.js"></script> -->
<style>
  .container-form {
    margin-top: 20px;
    padding: 0 15px;
    max-width: 100%;
    box-sizing: border-box;
    height: 100%;
  }

  .mssql-plugin-container {
    padding: 20px;
    width: 100%;
    margin: auto;
  }

  .mssql-plugin-form-group {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }

  .mssql-plugin-form-group label {
    margin-right: 10px;
    font-size: 14px;
  }

  .mssql-plugin-form-group select#mssqlDbConnection {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    height: 40px;
    box-sizing: border-box;
    margin-right: 10px;
    flex: 1;
  }

  .mssql-plugin-form-group button#mssqlFetchData {
    padding: 10px 20px;
    height: 40px;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    min-width: 150px;
  }

  .mssql-plugin-form-group button#mssqlFetchData:hover {
    background-color: #0056b3;
  }

  .error-message {
    color: red;
    margin-bottom: 20px;
    font-size: 16px;
  }

  .ag-grid-container {
    width: 100%;
    margin-top: 20px;
  }

  .button-submit {
    display: none; /* Hidden by default */
    margin-top: 20px;
    text-align: right;
    gap: 10px;
  }
</style>
{% endblock %} {% block content %}
<div class="container-form">
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h4>Проекты</h4>
    </div>
    <div class="mssql-plugin-container">
      <div class="mssql-plugin-form-group">
        <label for="mssqlDbConnection">Choose a Database Connection:</label>
        <select id="mssqlDbConnection">
          <!-- Options will be populated dynamically -->
        </select>
        <button id="mssqlFetchData">Fetch Data</button>
      </div>
      <div id="errorMessage" class="error-message"></div>
      <div class="ag-grid-container">
        <div
          id="myGrid"
          style="height: 50vh; width: 100%"
          class="ag-theme-alpine"
        ></div>
        <div id="buttonContainer" class="button-submit">
          <button
            id="button-send-datatoload"
            type="submit"
            class="btn btn-primary btn-no-margin"
            name="action"
            value="save"
          >
            Сохранить
          </button>
          <a
            href="javascript:history.back()"
            class="btn btn-sm btn-default btn-no-margin"
            data-toggle="tooltip"
            rel="tooltip"
            title=""
            data-original-title="Back"
          >
            <span class="sr-only">Назад</span>
            <i class="fa fa-arrow-left"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const dataToSend = [];

  document.addEventListener("DOMContentLoaded", function () {
    // Fetch available connections and populate the dropdown
    fetch("/mybaseview/fetch_airflow_connections")
      .then((response) => {
        if (!response.ok) {
          throw new Error(
            `Network response was not ok: ${response.statusText}`
          );
        }
        return response.json();
      })
      .then((data) => {
        const selectElement = document.getElementById("mssqlDbConnection");
        selectElement.innerHTML = "";
        data.connections.forEach((connId) => {
          const option = document.createElement("option");
          option.value = connId;
          option.text = connId;
          selectElement.appendChild(option);
        });
      })
      .catch((error) => {
        console.error("Error fetching connections:", error);
        const errorMessageDiv = document.getElementById("errorMessage");
        errorMessageDiv.textContent =
          "Error fetching connections: " + error.message;
      });

    // Add click event listener to the button
    document
      .getElementById("mssqlFetchData")
      .addEventListener("click", function () {
        const selectedConnection =
          document.getElementById("mssqlDbConnection").value;
        const errorMessageDiv = document.getElementById("errorMessage");
        const gridDiv = document.getElementById("myGrid");
        const buttonContainer = document.querySelector(".button-submit");

        // Clear previous messages or data
        errorMessageDiv.textContent = "";
        gridDiv.innerHTML = ""; // Clear the grid
        buttonContainer.style.display = "none"; // Hide the buttons initially

        // Show a loading indicator
        const loadingIndicator = document.createElement("div");
        loadingIndicator.textContent = "Loading...";
        gridDiv.appendChild(loadingIndicator);

        fetch(
          `/mybaseview/fetch_data?connection=${encodeURIComponent(
            selectedConnection
          )}`
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `Network response was not ok: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            // Remove loading indicator
            loadingIndicator.remove();

            if (data.status === "error") {
              // Display error message
              errorMessageDiv.textContent =
                data.message || "Failed to fetch data";
              return;
            }

            if (Array.isArray(data.columns) && Array.isArray(data.results)) {
              const columnDefs = data.columns.map((col) => ({
                headerName: col.toUpperCase(),
                field: col,
                flex: 1,
                editable: col === "load", // Make only the 'load' column editable
                cellRenderer:
                  col === "load" ? "agCheckboxCellRenderer" : undefined, // Checkbox renderer for 'load' column
              }));

              const rowData = data.results;

              const gridOptions = {
                columnDefs: columnDefs,
                rowData: rowData,
                pagination: true,
                paginationPageSize: 20,
                defaultColDef: {
                  sortable: true,
                  filter: true,
                  resizable: true,
                },
                onCellValueChanged: (event) => {
                  const field = event.colDef.field;
                  if (field === "load") {
                    const originalValue = event.oldValue;
                    const newValue = event.newValue;

                    if (originalValue !== newValue) {
                      const existingEntryIndex = dataToSend.findIndex(
                        (item) => item.table_name === event.data.table_name
                      );

                      if (existingEntryIndex !== -1) {
                        const existingChanges =
                          dataToSend[existingEntryIndex].changes || [];
                        const changeIndex = existingChanges.findIndex(
                          (change) => change.field === field
                        );

                        if (changeIndex !== -1) {
                          // Check if reverted to original value
                          if (
                            existingChanges[changeIndex].oldValue === newValue
                          ) {
                            // Remove this change if reverted to original
                            existingChanges.splice(changeIndex, 1);
                            if (existingChanges.length === 0) {
                              dataToSend.splice(existingEntryIndex, 1);
                            }
                          } else {
                            // Update the stored change
                            existingChanges[changeIndex].newValue = newValue;
                          }
                        } else {
                          // Add new change entry
                          existingChanges.push({
                            field: field,
                            oldValue: originalValue,
                            newValue: newValue,
                          });
                          dataToSend[existingEntryIndex].changes =
                            existingChanges;
                        }
                      } else {
                        // Add new entry
                        dataToSend.push({
                          table_name: event.data.table_name,
                          changes: [
                            {
                              field: field,
                              oldValue: originalValue,
                              newValue: newValue,
                            },
                          ],
                        });
                      }
                    }
                  }
                },
              };

              // Initialize the grid
              new agGrid.Grid(gridDiv, gridOptions);

              // Show the buttons now that the grid has loaded
              buttonContainer.style.display = "flex";
            } else {
              errorMessageDiv.textContent = "Invalid data format received.";
              console.error("Invalid data format:", data);
            }
          })
          .catch((error) => {
            // Remove loading indicator
            loadingIndicator.remove();

            errorMessageDiv.textContent =
              "Error fetching data: " + error.message;
            console.error("Error fetching data:", error);
          });
      });

    // Function to send the changes to the server when the button is clicked
    document
      .getElementById("button-send-datatoload")
      .addEventListener("click", function () {
        console.log("Data to send:");
        console.log(dataToSend);
        fetch("/mybaseview/update_data_is_load", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(dataToSend),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              alert("Data updated successfully!");
              // Clear the dataToSend array since the changes are now saved
              dataToSend.length = 0;
            } else {
              alert("Failed to update data: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error updating data:", error);
          });
      });
  });
</script>

{% endblock %}
